<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AnalystSage AI - Retro-Futuristic Intelligence</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#8B5CF6", // Vibrant Purple
                        "background-light": "#F5F3FF",
                        "background-dark": "#0B0E14",
                        accent: {
                            pink: "#EC4899",
                            cyan: "#06B6D4",
                            yellow: "#FBBF24"
                        }
                    },
                    fontFamily: {
                        display: ["'Plus Jakarta Sans'", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "1.5rem",
                        "2xl": "2rem",
                        "3xl": "3rem",
                    },
                    animation: {
                        'gradient-x': 'gradient-x 15s ease infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'spin-slow': 'spin 12s linear infinite',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' },
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0px) rotate(0deg)' },
                            '50%': { transform: 'translateY(-20px) rotate(5deg)' },
                        }
                    }
                },
            },
        };
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .retro-shadow {
            box-shadow: 8px 8px 0px 0px rgba(139, 92, 246, 0.3);
        }

        .card-stack::-webkit-scrollbar {
            display: none;
        }

        .card-stack {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen overflow-y-auto transition-colors duration-500">
    <div
        class="fixed inset-0 -z-10 bg-gradient-to-br from-purple-100 via-pink-50 to-cyan-100 dark:from-indigo-950 dark:via-purple-950 dark:to-slate-950 animate-gradient-x">
    </div>
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary/20 rounded-full blur-[120px] animate-pulse">
    </div>
    <div
        class="fixed bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-accent-cyan/20 rounded-full blur-[120px] animate-pulse">
    </div>

    <header class="relative px-8 py-6 flex justify-between items-center max-w-7xl mx-auto">
        <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='/'">
            <div
                class="w-12 h-12 bg-primary rounded-2xl flex items-center justify-center shadow-lg shadow-primary/30 rotate-3">
                <span class="material-icons-round text-white text-3xl">auto_awesome</span>
            </div>
            <div>
                <h1
                    class="text-2xl font-extrabold tracking-tight text-slate-900 dark:text-white uppercase transition-colors">
                    AnalystSage <span class="text-primary font-display lowercase tracking-tighter">AI</span></h1>
                <p class="text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-[0.3em]">Semantic
                    Intelligence</p>
            </div>
        </div>

        <nav
            class="hidden md:flex glass px-5 py-2.5 rounded-full items-center gap-4 shadow-xl border border-white/20 transition-all">
            <button
                class="p-2.5 text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors flex items-center justify-center"
                onclick="window.location.href='/chat_v2.html'" title="Ask Questions">
                <span class="material-icons-round text-sm">forum</span>
            </button>
            <div class="w-px h-6 bg-slate-300 dark:bg-slate-700 opacity-50"></div>
            <button
                class="p-2.5 text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors flex items-center justify-center"
                onclick="window.location.href='/audit_v2.html'" title="Audit Contracts">
                <span class="material-icons-round text-sm">gavel</span>
            </button>
            <button
                class="p-2.5 text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors flex items-center justify-center"
                onclick="window.location.href='/library_v2.html'" title="Document Library">
                <span class="material-icons-round text-sm">folder_special</span>
            </button>
            <button
                class="p-2.5 text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors flex items-center justify-center"
                title="Settings">
                <span class="material-icons-round text-sm">settings</span>
            </button>
            <div class="w-px h-6 bg-slate-300 dark:bg-slate-700 opacity-50"></div>
            <button
                class="p-2.5 text-slate-600 dark:text-slate-400 hover:text-accent-yellow transition-colors flex items-center justify-center"
                onclick="document.documentElement.classList.toggle('dark')">
                <span class="material-icons-round text-sm dark:hidden">dark_mode</span>
                <span class="material-icons-round text-sm hidden dark:block">light_mode</span>
            </button>
        </nav>
    </header>

    <main class="relative max-w-7xl mx-auto px-8 pt-4 pb-12 grid lg:grid-cols-2 gap-8 items-center">
        <div class="flex flex-col gap-8 order-2 lg:order-1">
            <div class="space-y-4">
                <span
                    class="inline-block px-4 py-1.5 rounded-full bg-accent-pink/10 text-accent-pink text-sm font-bold border border-accent-pink/20 uppercase tracking-wider">
                    Creative RAG Engine
                </span>
                <h2
                    class="text-4xl lg:text-6xl font-extrabold text-slate-900 dark:text-white leading-[1.1] tracking-tighter">
                    Ask your <br />
                    <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent-pink">Intelligence.</span>
                </h2>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center border-b border-white/10 pb-4">
                    <h3 class="font-black text-slate-800 dark:text-slate-200 uppercase text-xs tracking-[0.3em]">
                        Selected Archives</h3>
                </div>

                <input type="file" id="archive-upload-input" multiple class="hidden" onchange="handleArchiveUpload()">

                <div id="selected-archives-container" class="card-stack flex gap-6 overflow-x-auto pb-6 -mx-2 px-2">
                    <!-- Dynamic cards will be injected here by loadArchives() -->
                    <div onclick="document.getElementById('archive-upload-input').click()"
                        class="flex-shrink-0 w-24 h-32 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl flex flex-col items-center justify-center gap-1 hover:bg-slate-50/50 dark:hover:bg-slate-900/50 transition-colors cursor-pointer text-slate-400 group">
                        <span
                            class="material-icons-round text-xl group-hover:scale-125 transition-transform text-primary">add_circle</span>
                        <span class="text-[8px] font-black uppercase tracking-tighter text-primary">New Archive</span>
                    </div>
                </div>

                <!-- Query Input moved here, directly below docs -->
                <div class="relative group mt-4 max-w-4xl">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-primary via-accent-pink to-accent-cyan rounded-2xl blur opacity-25 group-focus-within:opacity-50 transition duration-1000">
                    </div>
                    <div class="relative glass rounded-2xl p-2.5 flex items-center gap-3 border-white/40">
                        <div class="flex-1 flex flex-col px-4">
                            <label
                                class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Semantic
                                Strategy Query</label>
                            <input id="query-input"
                                class="bg-transparent border-none focus:ring-0 text-slate-800 dark:text-white placeholder-slate-400 text-lg font-bold w-full p-0"
                                placeholder="Analyze specific archives..." type="text"
                                onkeydown="if(event.key === 'Enter') window.location.href='/chat_v2.html?q=' + encodeURIComponent(this.value)" />
                        </div>
                        <button id="search-btn"
                            onclick="window.location.href='/chat_v2.html?q=' + encodeURIComponent(document.getElementById('query-input').value)"
                            class="w-12 h-12 bg-slate-900 dark:bg-primary text-white rounded-xl flex items-center justify-center shadow-xl hover:scale-105 active:scale-95 transition-all">
                            <span class="material-icons-round text-2xl">rocket_launch</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="hidden lg:flex flex-col items-center justify-center order-1 lg:order-2">
            <div class="relative w-full max-w-md aspect-square flex items-center justify-center">
                <div class="animate-float relative z-10">
                    <div class="w-48 h-48 relative">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-primary to-accent-pink rounded-[3rem] shadow-2xl flex items-center justify-center p-8">
                            <div
                                class="w-full h-full bg-slate-900 rounded-[2rem] flex flex-col items-center justify-center gap-4 overflow-hidden border-4 border-white/20">
                                <div class="flex gap-6">
                                    <div
                                        class="w-8 h-8 bg-accent-cyan rounded-full animate-pulse shadow-[0_0_15px_rgba(6,182,212,0.8)]">
                                    </div>
                                    <div
                                        class="w-8 h-8 bg-accent-cyan rounded-full animate-pulse shadow-[0_0_15px_rgba(6,182,212,0.8)]">
                                    </div>
                                </div>
                                <div class="flex items-end gap-1 h-8">
                                    <div
                                        class="w-1.5 h-4 bg-primary rounded-full animate-bounce [animation-delay:0.1s]">
                                    </div>
                                    <div
                                        class="w-1.5 h-6 bg-primary rounded-full animate-bounce [animation-delay:0.2s]">
                                    </div>
                                    <div
                                        class="w-1.5 h-8 bg-primary rounded-full animate-bounce [animation-delay:0.3s]">
                                    </div>
                                    <div
                                        class="w-1.5 h-5 bg-primary rounded-full animate-bounce [animation-delay:0.4s]">
                                    </div>
                                    <div
                                        class="w-1.5 h-3 bg-primary rounded-full animate-bounce [animation-delay:0.5s]">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="absolute -top-10 -right-10 w-24 h-24 bg-accent-yellow/20 backdrop-blur-md border border-accent-yellow/30 rounded-full flex items-center justify-center animate-spin-slow">
                            <span class="material-icons-round text-accent-yellow text-4xl">psychology</span>
                        </div>
                    </div>
                </div>
                <div class="absolute inset-0 -z-10 opacity-30 dark:opacity-20">
                    <div
                        class="absolute top-0 left-0 w-32 h-32 border-4 border-primary rounded-full translate-x-12 translate-y-12">
                    </div>
                    <div
                        class="absolute bottom-0 right-0 w-48 h-48 border-4 border-accent-cyan rounded-[2rem] rotate-45">
                    </div>
                    <div
                        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-full">
                    </div>
                </div>
            </div>
            <div class="mt-8 opacity-0">
                <!-- Spacing element -->
            </div>
        </div>
    </main>

    <!-- Results Area -->
    <div id="results-area" class="max-w-7xl mx-auto px-8 space-y-10 pb-40">
        <!-- Q&A Results will be injected here -->
    </div>

    <footer
        class="fixed bottom-4 left-8 text-[10px] font-extrabold uppercase tracking-[0.2em] text-slate-400 hidden xl:block">
        AnalystSage AI Studio
    </footer>

    <script>
        // Simple reactive-like feel for the mascot
        const chatContainer = document.querySelector('.cursor-pointer');
        const eyes = document.querySelectorAll('.animate-pulse.bg-accent-cyan');
        if (chatContainer) {
            chatContainer.addEventListener('mouseenter', () => {
                eyes.forEach(eye => {
                    eye.classList.remove('bg-accent-cyan');
                    eye.classList.add('bg-accent-pink');
                    eye.classList.add('scale-110');
                });
            });
            chatContainer.addEventListener('mouseleave', () => {
                eyes.forEach(eye => {
                    eye.classList.remove('bg-accent-pink');
                    eye.classList.remove('scale-110');
                    eye.classList.add('bg-accent-cyan');
                });
            });
        }

        // Archive Management Logic
        async function loadArchives() {
            const container = document.getElementById('selected-archives-container');
            const uploadBtn = container.querySelector('div[onclick*="archive-upload-input"]');

            try {
                const res = await fetch('/api/sources');
                const data = await res.json();

                // Keep the upload button
                container.innerHTML = '';
                container.appendChild(uploadBtn);

                data.sources.slice(0, 5).forEach((source, i) => {
                    const card = document.createElement('div');
                    card.className = `flex-shrink-0 w-24 h-32 glass rounded-2xl p-3 flex flex-col justify-between border border-primary/20 hover:border-primary transition-all cursor-pointer group ${i % 2 === 0 ? 'hover:-rotate-2' : 'hover:rotate-2'}`;
                    card.innerHTML = `
                        <div class="w-7 h-7 ${i % 2 === 0 ? 'bg-primary/20 text-primary' : 'bg-accent-cyan/20 text-accent-cyan'} rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                            <span class="material-icons-round text-sm">${i % 2 === 0 ? 'description' : 'history_edu'}</span>
                        </div>
                        <div>
                            <p class="font-bold text-slate-800 dark:text-white line-clamp-2 mb-0.5 text-[9px] uppercase tracking-tighter">${source}</p>
                            <p class="text-[7px] text-slate-500 uppercase font-bold tracking-tighter italic">Active</p>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (err) {
                console.error("Failed to sync archives:", err);
            }
        }

        async function handleArchiveUpload() {
            const input = document.getElementById('archive-upload-input');
            if (input.files.length === 0) return;

            const formData = new FormData();
            for (const file of input.files) {
                formData.append('files', file);
            }

            // Simple toast/alert for feedback since this is v2 mockup
            console.log("Ingesting intelligence cards...");

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                alert(`Strategic Success: ${data.results.length} archives integrated.`);
                loadArchives();
            } catch (err) {
                alert(`System Error: Ingestion failed - ${err.message}`);
            } finally {
                input.value = '';
            }
        }

        // Initial sync
        window.addEventListener('load', loadArchives);

        // --- Query Logic ---
        async function performQuery() {
            const input = document.getElementById('query-input');
            const question = input.value.trim();
            const btn = document.getElementById('search-btn');

            if (!question) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons-round animate-spin">sync</span>';

            const resultsArea = document.getElementById('results-area');
            const requestId = Date.now();

            resultsArea.insertAdjacentHTML('afterbegin', `
                <div id="query-${requestId}" class="space-y-8 animate-in slide-in-from-bottom-5 duration-700 mb-12">
                    <div class="flex gap-6 items-center pl-6">
                        <div class="w-12 h-12 rounded-2xl bg-slate-900 dark:bg-slate-100 flex items-center justify-center text-white dark:text-slate-900 text-sm font-black shadow-xl">Q</div>
                        <p class="font-black text-2xl text-slate-900 dark:text-white tracking-tight">${question}</p>
                    </div>
                    <div id="response-${requestId}" class="glass rounded-[3rem] p-12 border-white/50 shadow-2xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-2 h-full bg-primary"></div>
                        <div class="flex items-center gap-4 text-primary mb-8">
                            <span class="material-icons-round text-3xl">auto_awesome</span>
                            <h3 class="font-black uppercase tracking-[0.3em] text-[10px]">Semantic Synthesis</h3>
                        </div>
                        <div class="text-slate-700 dark:text-slate-200 leading-relaxed text-xl font-medium" id="text-${requestId}">
                           <div class="space-y-4">
                               <div class="h-5 bg-slate-200/50 dark:bg-slate-700/50 rounded-full w-3/4 animate-pulse"></div>
                               <div class="h-5 bg-slate-200/50 dark:bg-slate-700/50 rounded-full w-1/2 animate-pulse"></div>
                           </div>
                        </div>
                        <div id="sources-${requestId}" class="mt-12 grid grid-cols-2 lg:grid-cols-4 gap-4 hidden border-t border-white/10 pt-8"></div>
                    </div>
                </div>
            `);

            input.value = '';
            input.blur();

            try {
                const formData = new FormData();
                formData.append('question', question);

                const res = await fetch('/api/query', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";
                const textContainer = document.getElementById(`text-${requestId}`);

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.substring(6));
                                if (event.type === 'text') {
                                    fullText += event.content;
                                    textContainer.innerText = fullText;
                                } else if (event.type === 'final') {
                                    renderSources(requestId, event.content.sources);
                                } else if (event.type === 'error') {
                                    throw new Error(event.content);
                                }
                            } catch (e) {
                                console.error("Error parsing event:", e);
                            }
                        }
                    }
                }
            } catch (err) {
                console.error("Query failed:", err);
                const textContainer = document.getElementById(`text-${requestId}`);
                textContainer.innerHTML = `<span class="text-red-500 font-black uppercase text-xs tracking-widest">Synthesis Error: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons-round text-2xl">rocket_launch</span>';
            }
        }

        function renderSources(requestId, sources) {
            const container = document.getElementById(`sources-${requestId}`);
            if (!sources || sources.length === 0) return;

            container.classList.remove('hidden');
            container.innerHTML = sources.map(s => `
                <div class="p-5 bg-white/5 border border-white/10 rounded-2xl group hover:bg-primary/5 hover:border-primary/20 transition-all">
                    <p class="text-[8px] font-black text-primary uppercase tracking-[0.2em] mb-2 pl-1">Knowledge Node</p>
                    <p class="text-[10px] font-black text-slate-800 dark:text-slate-200 line-clamp-1 uppercase tracking-tighter">${s.source}</p>
                    <p class="text-[8px] text-slate-400 font-bold mt-1 tracking-widest">Ref: Page ${s.pages.join(', ')}</p>
                </div>
            `).join('');
        }
    </script>
</body>

</html>